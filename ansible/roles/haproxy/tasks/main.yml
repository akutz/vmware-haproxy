# Copyright (c) 2020 VMware, Inc. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
---
- name: Install DataPlane API
  get_url:
    url: '{{ dataplane_api_url }}'
    dest: /usr/local/bin/dataplaneapi
    mode: "0755"

- name: Create HAProxy service drop-in directory
  file:
    path: /etc/systemd/system/haproxy.service.d
    state: directory

- name: Create HAProxy cloud-init drop-in file
  copy:
    src: files/etc/systemd/system/haproxy.service.d/cloud-init.conf
    dest: /etc/systemd/system/haproxy.service.d/cloud-init.conf
    owner: root
    group: root
    mode: "0644"

- name: Create HAProxy configuration file
  copy:
    src: files/etc/haproxy/haproxy.cfg
    dest: /etc/haproxy/haproxy.cfg
    owner: root
    group: root
    mode: "0644"

- name: Create anyip configuration file
  copy:
    src: files/etc/haproxy/anyip.cfg
    dest: /etc/haproxy/anyip.cfg
    owner: root
    group: root
    mode: "0644"

- name: Update DataPlane API reload command
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: 'kill -SIGUSR2 1'
    replace: '/usr/bin/systemctl reload haproxy'

- name: Update HAProxy log level
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: 'log stdout format raw local0 debug'
    replace: 'log stdout format raw local0 info'

- name: Update DataPlane API log level
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: '--log-level=debug'
    replace: '--log-level=warning'

- name: Enable HAProxy service
  systemd:
    name: haproxy
    enabled: yes
    daemon_reload: yes

- name: Remove default HAProxy user
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: '  user client insecure-password cert'
    replace: ''
