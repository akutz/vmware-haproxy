# Copyright (c) 2020 VMware, Inc. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
---
- name: Install DataPlane API
  get_url:
    url: '{{ dataplane_api_url }}'
    dest: /usr/local/bin/dataplaneapi
    mode: "0755"

- name: Download HAProxy 2.2.2
  get_url:
    url: '{{ haproxy_rpm_url }}'
    dest: /root/haproxy-2.2.2.rpm
  when: haproxy_rpm_url != ''

- name: Install HAProxy 2.2.2
  command: sh -c 'rpm --upgrade -vh /root/haproxy-2.2.2.rpm || true'
  when: haproxy_rpm_url != ''

- name: Create HAProxy service drop-in directory
  file:
    path: /etc/systemd/system/haproxy.service.d
    state: directory

- name: Create HAProxy cloud-init drop-in file
  copy:
    src: files/etc/systemd/system/haproxy.service.d/cloud-init.conf
    dest: /etc/systemd/system/haproxy.service.d/cloud-init.conf
    owner: root
    group: root
    mode: "0644"

- name: Create HAProxy slice drop-in file
  copy:
    src: files/etc/systemd/system/haproxy.service.d/slice.conf
    dest: /etc/systemd/system/haproxy.service.d/slice.conf
    owner: root
    group: root
    mode: "0644"

- name: Create Dataplane API systemd file
  copy:
    src: files/etc/systemd/system/dataplaneapi.service
    dest: /etc/systemd/system/dataplaneapi.service
    owner: root
    group: root
    mode: "0644"

- name: Create Dataplane API systemd slice file
  copy:
    src: files/etc/systemd/system/dataplaneapi.slice
    dest: /etc/systemd/system/dataplaneapi.slice
    owner: root
    group: root
    mode: "0644"

- name: Create HAProxy configuration file
  copy:
    src: files/etc/haproxy/haproxy.cfg
    dest: /etc/haproxy/haproxy.cfg
    owner: root
    group: root
    mode: "0644"

# The choice of 60000 maximum, concurrent connections was decided as a
# result of performance testing using Weathervane on a deployed HAProxy
# appliance with 2 cores and 4 GiB of memory, the default resource
# allocation for the appliance.
- name: Update HAProxy maxconn to 60000
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: '^(\s+)maxconn(\s+)\d+'
    replace: '\1maxconn\g<2>60000'

- name: Update DataPlane API reload command
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: 'kill -SIGUSR2 1'
    replace: '/usr/bin/systemctl reload haproxy'

- name: Update HAProxy log level
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: 'log stdout format raw local0 debug'
    replace: 'log stdout format raw local0 info'

- name: Update DataPlane API log level
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: '--log-level=debug'
    replace: '--log-level=warning'

- name: Enable HAProxy service
  systemd:
    name: haproxy
    enabled: yes
    daemon_reload: yes

- name: Enable Dataplane API service
  systemd:
    name: dataplaneapi
    enabled: yes
    daemon_reload: yes

- name: Remove default HAProxy user
  replace:
    path: /etc/haproxy/haproxy.cfg
    regexp: '  user client insecure-password cert'
    replace: ''
